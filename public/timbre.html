<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Timbre - CÃ¡mara</title>
  <style>
    body {
      margin: 0;
      padding: 0;
      background-color: black;
      color: white;
      font-family: sans-serif;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      height: 100vh;
    }

    video {
      width: 100%;
      max-height: 80vh;
      background: #000;
    }
  </style>
</head>
<body>
  <h2>Dispositivo del Timbre</h2>
  <video id="videoPreview" autoplay muted playsinline></video>

  <script src="/socket.io/socket.io.js"></script>
  <script type="module">
    const socket = io();
    const video = document.getElementById('videoPreview');
    let stream;
    let peerConnection;

    async function iniciarCamara() {
      try {
        stream = await navigator.mediaDevices.getUserMedia({
          video: true,
          audio: false
        });

        video.srcObject = stream;
        console.log("âœ… CÃ¡mara activada correctamente.");
      } catch (err) {
        console.error("âŒ Error al acceder a la cÃ¡mara:", err);
        alert("No se pudo acceder a la cÃ¡mara. Revisa los permisos.");
      }
    }

    async function crearPeerConnection() {
      peerConnection = new RTCPeerConnection();

      stream.getTracks().forEach(track => {
        peerConnection.addTrack(track, stream);
      });

      peerConnection.onicecandidate = (event) => {
        if (event.candidate) {
          socket.emit("ice-candidate", {
            candidate: event.candidate
          });
        }
      };

      socket.on("answer", async ({ answer }) => {
        console.log("ðŸ“¨ Respuesta recibida del visor.");
        await peerConnection.setRemoteDescription(new RTCSessionDescription(answer));
      });

      socket.on("ice-candidate", async ({ candidate }) => {
        if (candidate) {
          try {
            await peerConnection.addIceCandidate(new RTCIceCandidate(candidate));
          } catch (e) {
            console.error("Error aÃ±adiendo ICE candidate:", e);
          }
        }
      });

      const offer = await peerConnection.createOffer();
      await peerConnection.setLocalDescription(offer);

      socket.emit("offer", {
        offer
      });

      console.log("ðŸ“¡ Oferta enviada al visor.");
    }

    // Escuchar cuando alguien quiere conectarse
    socket.on("viewer-ready", async () => {
      console.log("ðŸ‘€ Visor conectado. Iniciando conexiÃ³n WebRTC...");
      await crearPeerConnection();
    });

    // Iniciar cÃ¡mara automÃ¡ticamente
    iniciarCamara();
  </script>
</body>
</html>
